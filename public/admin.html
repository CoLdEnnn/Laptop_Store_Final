<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Admin</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <h2>Admin Panel</h2>

    <p><a href="index.html">Back</a></p>

    <h3>Add Laptop</h3>
    <input id="brand" placeholder="Brand" />
    <input id="model" placeholder="Model" />
    <input id="price" placeholder="Price" />
    <input id="stock" placeholder="Stock" />
    <button onclick="addLaptop()">Add</button>

    <h3>Laptops</h3>
    <div id="laptops">Loading...</div>

    <h3>Orders (admin)</h3>
    <div id="orders">Loading...</div>

    <script>
      const token = localStorage.getItem("token");
      const role = localStorage.getItem("role");
      if (!token || role !== "admin") {
        alert("Admin only");
        location.href = "index.html";
      }

      function authHeaders() {
        return { Authorization: "Bearer " + token };
      }

      async function addLaptop() {
        const res = await fetch("/api/laptops", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({
            brand: brand.value,
            model: model.value,
            price: Number(price.value),
            stock: Number(stock.value || 0),
          }),
        });

        const data = await res.json();
        if (!res.ok) return alert(data.message || "Add failed");
        alert("Added");
        loadLaptops();
      }

      async function delLaptop(id) {
        if (!confirm("Delete laptop?")) return;
        const res = await fetch("/api/laptops/" + id, {
          method: "DELETE",
          headers: authHeaders(),
        });
        const data = await res.json();
        if (!res.ok) return alert(data.message || "Delete failed");
        loadLaptops();
      }

      async function loadLaptops() {
        const res = await fetch("/api/laptops");
        const data = await res.json();
        document.getElementById("laptops").innerHTML = data
          .map(
            (l) => `
            <div class="card">
              <b>${l.brand} ${l.model}</b> - $${l.price} | stock: ${l.stock}
              <div style="margin-top: 10px;">
                <button onclick="editLaptop('${l._id}', '${l.brand}', '${l.model}', ${l.price}, ${l.stock})">Edit</button>
                <button onclick="delLaptop('${l._id}')">Delete</button>
              </div>
            </div>`,
          )
          .join("");
      }
      async function editLaptop(id, oldBrand, oldModel, oldPrice, oldStock) {
        const newPrice = prompt("Enter new price:", oldPrice);
        const newStock = prompt("Enter new stock:", oldStock);

        if (newPrice === null || newStock === null) return;

        const res = await fetch("/api/laptops/" + id, {
          method: "PUT",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({
            brand: oldBrand,
            model: oldModel,
            price: Number(newPrice),
            stock: Number(newStock),
          }),
        });

        const data = await res.json();
        if (!res.ok) return alert(data.message || "Update failed");

        alert("Updated");
        loadLaptops();
      }
      async function loadOrders() {
        const res = await fetch("/api/orders", { headers: authHeaders() });
        const data = await res.json();
        if (!res.ok)
          return (document.getElementById("orders").innerText =
            data.message || "Error");

        document.getElementById("orders").innerHTML = data
          .map(
            (o) => `
            <div style="padding:8px;border:1px solid #ddd;margin:8px 0;">
              <b>${o._id}</b> | status: ${o.status} | total: $${o.total}
              <div>${o.items.map((i) => `${i.brand} ${i.model} x${i.qty}`).join(", ")}</div>
              <select onchange="setStatus('${o._id}', this.value)">
                <option value="">Change status</option>
                <option value="created">created</option>
                <option value="paid">paid</option>
                <option value="shipped">shipped</option>
                <option value="cancelled">cancelled</option>
              </select>
            </div>`,
          )
          .join("");
      }

      async function setStatus(id, status) {
        if (!status) return;
        const res = await fetch("/api/orders/" + id + "/status", {
          method: "PATCH",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ status }),
        });
        const data = await res.json();
        if (!res.ok) return alert(data.message || "Status update failed");
        loadOrders();
      }

      loadLaptops();
      loadOrders();
    </script>
  </body>
</html>
