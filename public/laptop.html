<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Laptop</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div id="laptop">Loading...</div>

    <button onclick="buy()">Buy (creates order)</button>

    <h3>Add review (1..5)</h3>
    <input id="rating" placeholder="Rating 1..5" />
    <input id="comment" placeholder="Comment" />
    <button onclick="addReview()">Add Review</button>
    <nav>
      <a href="laptops.html">Back</a>
    </nav>
    <script>
      const token = localStorage.getItem("token");
      const id = new URLSearchParams(location.search).get("id");

      function authHeaders() {
        return token ? { Authorization: "Bearer " + token } : {};
      }

      async function load() {
        const res = await fetch(`/api/laptops/${id}`);
        const l = await res.json();

        document.getElementById("laptop").innerHTML = `
          <h2>${l.brand} ${l.model}</h2>
          <p>Price: $${l.price}</p>
          <p>Stock: ${l.stock}</p>
          <p>Reviews: ${l.reviews?.length || 0}</p>
        `;
      }

      async function buy() {
        if (!token) return alert("Login first");

        const res = await fetch("/api/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ items: [{ laptopId: id, qty: 1 }] }),
        });

        const data = await res.json();
        if (!res.ok) return alert(data.message || "Buy failed");

        alert("Order created: " + data._id);
        load();
      }

      async function addReview() {
        if (!token) return alert("Login first");

        const res = await fetch(`/api/laptops/${id}/reviews`, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({
            rating: rating.value,
            comment: comment.value,
          }),
        });

        const data = await res.json();
        if (!res.ok) return alert(data.message || "Review failed");

        alert("Review added");
        load();
      }

      load();
    </script>
  </body>
</html>
